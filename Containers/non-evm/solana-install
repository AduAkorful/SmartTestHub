#!/usr/bin/env bash

set -e

usage() {
  cat <<EOF
Solana Install Script

This script installs the Solana CLI tools.

Options:
  -h, --help            Show this help message and exit
  -v, --version <ver>   Install a specific version (default: stable)
  -d, --data-dir <dir>  Specify a directory to install to (default: ~/.local/share/solana/install)
  -n, --no-modify-path  Do not modify the PATH environment variable
  -r, --release         Use stable, beta, or edge release (default: stable)
EOF
}

RELEASE_CHANNEL="stable"
INSTALL_DATA_DIR="${HOME}/.local/share/solana/install"
MODIFY_PATH=true

while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      usage
      exit 0
      ;;
    -v|--version)
      shift
      RELEASE_CHANNEL="$1"
      ;;
    -d|--data-dir)
      shift
      INSTALL_DATA_DIR="$1"
      ;;
    -n|--no-modify-path)
      MODIFY_PATH=false
      ;;
    -r|--release)
      shift
      RELEASE_CHANNEL="$1"
      ;;
    *)
      echo "Unknown option: $1"
      usage
      exit 1
      ;;
  esac
  shift
done

URL="https://release.solana.com/${RELEASE_CHANNEL}/solana-release-x86_64-unknown-linux-gnu.tar.bz2"

echo "Downloading Solana release from $URL"
mkdir -p "$INSTALL_DATA_DIR"
cd "$INSTALL_DATA_DIR"
curl -sSfL "$URL" -o solana-release.tar.bz2

echo "Extracting Solana release..."
tar -xjf solana-release.tar.bz2
rm solana-release.tar.bz2

if $MODIFY_PATH; then
  PROFILE_FILE="${HOME}/.profile"
  BIN_PATH="${INSTALL_DATA_DIR}/active_release/bin"
  if ! grep -q "$BIN_PATH" "$PROFILE_FILE"; then
    echo "export PATH=\"$BIN_PATH:\$PATH\"" >> "$PROFILE_FILE"
    echo "Added Solana CLI tools to PATH in $PROFILE_FILE"
  fi
fi

echo "Solana CLI tools installed successfully."
echo "To use Solana CLI tools, you may need to restart your shell or source your profile file:"
echo "  source ~/.profile"
